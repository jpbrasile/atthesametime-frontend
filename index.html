<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Local Test</title>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.6;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 40px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .status-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 4px;
            word-wrap: break-word;
        }
        .error-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            border-radius: 4px;
        }
        .success {
            color: #155724;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .log-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            padding: 8px 16px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #3367d6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Supabase Local Test</h1>
        <p>This page connects to your local Supabase instance and displays authentication events.</p>
        
        <div>
            <button id="test-api">Test API Connection</button>
            <button id="test-auth">Test Auth Service</button>
        </div>
        
        <div class="status-box" id="status">Waiting for Supabase library to load...</div>
        
        <div id="error-box" class="error-box" style="display: none;">
            <span id="error-message"></span>
        </div>
        
        <div class="log-container" id="log-container">
            <!-- Console logs will appear here -->
        </div>
    </div>

    <!-- Load Supabase with regular script tag, not defer -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.js"></script>

    <script>
        // DOM elements
        const statusDiv = document.getElementById('status');
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');
        const logContainer = document.getElementById('log-container');
        const testApiButton = document.getElementById('test-api');
        const testAuthButton = document.getElementById('test-auth');
        
        // Utility function to log to screen and console
        function log(message, type = 'info') {
            console[type](message);
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${type.toUpperCase()}] ${message}`;
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'warn' ? '#ffc107' : '#212529';
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Show error
        function showError(message) {
            errorMessage.textContent = message;
            errorBox.style.display = 'block';
            log(message, 'error');
        }
        
        // Configuration
        //const SUPABASE_URL = 'http://localhost:8000';  // Using localhost instead of 127.0.0.1
        //const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.ewogICJyb2xlIjogImFub24iLAogICJpc3MiOiAic3VwYWJhc2UiLAogICJpYXQiOiAxNzQzMDMwMDAwLAogICJleHAiOiAxOTAwNzk2NDAwCn0.9Jd00pwD3N-TexiFoBfjit4nbf-dMNiaX_4wB63CNjw';
        const SUPABASE_URL='https://supabase.atthesametime.eu'; 
        const SUPABASE_ANON_KEY='eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJzdXBhYmFzZSIsImlhdCI6MTc0MzQ0MTEyMCwiZXhwIjo0ODk5MTE0NzIwLCJyb2xlIjoiYW5vbiJ9.tDUWbpLozT-ABGlKDzA7fkQVSNFlLMNgFOxzwU8mzU0';
        // Wait for page to fully load
        window.addEventListener('load', function() {
            log('Page loaded, checking for Supabase library...');
            
            // Check if Supabase is loaded
            if (typeof supabase === 'undefined') {
                showError("Supabase library failed to load. Check your network connection and try again.");
                statusDiv.textContent = 'ERROR: Supabase library not loaded';
                return;
            }
            
            log('Supabase library detected. Version: ' + (supabase.version || 'unknown'));
            statusDiv.textContent = 'Initializing connection to Supabase...';
            
            try {
                // Initialize Supabase client
                log(`Initializing with URL: ${SUPABASE_URL} and key: ${SUPABASE_ANON_KEY.substring(0, 10)}...`);
                const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                if (!supabaseClient) {
                    throw new Error('Failed to create Supabase client object');
                }
                
                log('Supabase client created successfully', 'info');
                statusDiv.textContent = 'Supabase client initialized. Listening for auth events...';
                
                // Listen for auth state changes
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    log(`Auth event: ${event}, Session exists: ${!!session}`);
                    
                    let statusMessage = '';
                    switch(event) {
                        case 'INITIAL_SESSION':
                            statusMessage = session 
                                ? `<span class="success">Initial session loaded. Logged in as ${session.user.email}</span>` 
                                : 'No active user session found.';
                            break;
                        case 'SIGNED_IN':
                            statusMessage = `<span class="success">Sign in successful! Welcome ${session.user.email}</span>`;
                            break;
                        case 'SIGNED_OUT':
                            statusMessage = 'User signed out.';
                            break;
                        default:
                            statusMessage = `Auth event received: ${event}`;
                    }
                    
                    statusDiv.innerHTML = statusMessage;
                });
                
                // Setup test API button
                testApiButton.addEventListener('click', function() {
                    log('Testing API connection...');
                    supabaseClient.from('_dummy_query_').select('*', { count: 'exact' })
                        .then(response => {
                            log('API response received: ' + (response.error ? 'ERROR' : 'SUCCESS'));
                            
                            if (response.error) {
                                log('API error: ' + response.error.message, 'error');
                                // This is actually expected for a non-existent table, but response should come back
                                statusDiv.innerHTML = `API test: <span class="success">CONNECTION OK</span> (Expected error: ${response.error.message})`;
                            } else {
                                statusDiv.innerHTML = `API test: <span class="success">SUCCESS</span>`;
                            }
                        })
                        .catch(error => {
                            log('API connection failed: ' + error.message, 'error');
                            statusDiv.innerHTML = `API test: <span class="error">FAILED</span> - ${error.message}`;
                        });
                });
                
                // Setup test auth button
                testAuthButton.addEventListener('click', function() {
                    log('Testing Auth service...');
                    supabaseClient.auth.getSession()
                        .then(response => {
                            log('Auth service response received');
                            statusDiv.innerHTML = `Auth service test: <span class="success">CONNECTION OK</span>`;
                            
                            if (response.data.session) {
                                statusDiv.innerHTML += `<br>Session exists for user: ${response.data.session.user.email}`;
                            } else {
                                statusDiv.innerHTML += '<br>No active session found';
                            }
                        })
                        .catch(error => {
                            log('Auth service error: ' + error.message, 'error');
                            statusDiv.innerHTML = `Auth service test: <span class="error">FAILED</span> - ${error.message}`;
                        });
                });
                
            } catch (error) {
                log('Failed to initialize Supabase: ' + error.message, 'error');
                showError(`Initialization failed: ${error.message}`);
                statusDiv.textContent = 'Supabase initialization failed';
            }
        });
    </script>
</body>
</html>